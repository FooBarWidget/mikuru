#!/usr/bin/env ruby
# Mikuru 1.0.0 - Simple image gallery generator
# Copyright (c) 2007, Hongli Lai
# 
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without modification,
# are permitted provided that the following conditions are met:
# 
# * Redistributions of source code must retain the above copyright notice, this
#   list of conditions and the following disclaimer.
# * Redistributions in binary form must reproduce the above copyright notice, this
#   list of conditions and the following disclaimer in the documentation and/or
#   other materials provided with the distribution.
# * Neither the name of Hongli Lai nor the names of its contributors may be used
#   to endorse or promote products derived from this software without specific
#   prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

require 'RMagick'
require 'erb'

MAX_WIDTH = 150
MAX_HEIGHT = 150
include ERB::Util

def start
	if !File.exist?('thumbnails')
		puts "MKDIR      thumbnails"
		Dir.mkdir('thumbnails')
	end

	images = []
	dir = Dir.new('.')
	dir.sort.each do |name|
		if isImage(name)
			if !hasThumbnail(name)
				createThumbnail(name)
			end
			images << name
		end
	end
	dir.close
	
	puts "WRITE      index.html"
	template_file = File.dirname(__FILE__) + "/../data/mikuru.erb.html"
	template = nil
	File.open(template_file, "r") do |f|
		template = ERB.new(f.read)
	end
	File.open("index.html", "w") do |f|
		f.write(template.result(binding))
	end
end

def isImage(name)
	return name !~ /^\./ && name =~ /\.jpg$/i
end

def hasThumbnail(name)
	return File.exist?("thumbnails/#{name}")
end

def createThumbnail(name)
	image = Magick::Image.read(name).first
	if image.columns > image.rows
		width = MAX_WIDTH
		height = image.rows * (MAX_WIDTH / image.columns.to_f)
	else
		height = MAX_HEIGHT
		width = image.columns * (MAX_HEIGHT / image.rows.to_f)
	end
	image.thumbnail!(width, height)

	final = Magick::Image.new(MAX_WIDTH, MAX_HEIGHT)
	final.composite!(image, Magick::CenterGravity, Magick::OverCompositeOp)
	puts "WRITE      thumbnails/#{name}"
	final.write("thumbnails/#{name}")
end

start
